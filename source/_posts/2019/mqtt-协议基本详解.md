---
title: MQTT - 协议基本详解
date: 2019-06-27 10:58:33
categories: [MQTT]
tags:
    - MQTT
---

MQTT 全称为 `Message Queuing Telemetry Transport`（消息队列遥测传输）是一种基于发布/订阅范式的 **轻量级** 消息协议，由 IBM 发布。

MQTT 可以被解释为一种低开销，低带宽占用的即时通讯协议，可以用极少的代码和带宽的为连接远程设备提供实时可靠的消息服务，它适用于硬件性能低下的远程设备以及网络状况糟糕的环境下，因此 MQTT 协议在 IoT（Internet of things，物联网），小型设备应用，移动应用等方面有较广泛的应用。

IoT 设备要运作，就必须连接到互联网，设备才能相互协作，以及与后端服务协同工作。而互联网的基础网络协议是 TCP/IP，MQTT 协议是基于 TCP/IP 协议栈而构建的，因此它已经慢慢的已经成为了 IoT 通讯的标准。

在简介完 MQTT 协议后，EMQ君将从其一些基本特点和基本概念为两部分，介绍 MQTT 协议。

<!-- more -->

## 基本特点

MQTT 是一种 **发布/订阅** 传输协议，基本原理和实现如下：

![MQTT 流程](/uploads/images/posts/mqtt/mqtt-flow.png)

1. MQTT 协议提供一对多的消息发布，可以解除应用程序耦合，信息冗余小。该协议需要客户端和服务端，而协议中主要有三种身份：发布者（Publisher）、代理（Broker，服务器）、订阅者（Subscriber）。其中，消息的发布者和订阅者都是客户端，消息代理是服务器，而消息发布者可以同时是订阅者，实现了生产者与消费者的脱耦。

2. 使用 TCP/IP 提供网络连接，提供有序、无损、双向连接；MQTT 是一种连接协议，它指定了如何组织数据字节并通过 TCP/IP 网络传输它们。设备联网，也需要连接到互联网中，在大万维的世界中，TCP 如同汽车，有轮子就能用来运输数据，MQTT 就像是交通规则。在网络模型中，TCP是传输层协议，而 MQTT是在应用层，在 TCP 的上层，因此MQTT 也是基于这个而构建的，提高了可靠性。

3. 对负载内容屏蔽的消息传输；可以对消息订阅者所接受到的内容有所屏蔽。

4. 具体有三种消息发布的服务质量（`QoS`）
    - `至多一次（QoS0）`：消息发布完全依赖底层 TCP/IP 网络。会发生消息丢失或重复。这一级别可用于如下情况，环境传感器数据，丢失一次读记录无所谓，因为不久后还会有第二次发送。
    - `至少一次（QoS1）`：确保消息到达，但消息重复可能会发生。
    - `只有一次（QoS2）`：确保消息到达一次。这一级别可用于如下情况，在计费系统中，消息重复或丢失会导致不正确的结果。


5. 小型传输，开销小，固定长度的头部是 2 字节，协议交换最小化，以降低网络流量；整体上协议可拆分为：固定头部+可变头部+消息体，这就是为什么在介绍里说它非常适合 **在物联网领域，传感器与服务器的通信，信息的收集**。

6. 使用 `Last Will` 和 `Testament` 特性通知有关各方客户端异常中断的机制；
    - `Last Will`：即遗言机制，用于通知同一主题下的其他设备发送遗言的设备已经断开了连接。
    - `Testament`：遗嘱机制，功能类似于Last Will。

## 基本术语

#### 网络连接 Network Connection

MQTT使用的底层传输协议基础设施。

- 客户端使用它连接服务端。
- 它提供有序的、可靠的、双向字节流传输。

#### 应用消息 Application Message

MQTT协议通过网络传输应用数据，应用消息通过MQTT传输时，它们有关联的服务质量（QoS）和主题（Topic）。

#### 客户端 Client

使用 MQTT 的程序或设备，客户端总是通过网络连接到服务端，它可以：

- 发布应用消息给其它相关的客户端。
- 订阅以请求接受相关的应用消息
- 取消订阅以移除接受应用消息的请求。
- 从服务端断开连接。

#### 服务端 Server

一个程序或设备，作为发送消息的客户端和请求订阅的客户端之间的中介，他需要：

- 接受来自客户端的网络连接
- 接受客户端发布的应用消息
- 处理客户端的订阅和取消订阅请求。
- 转发应用消息给符合条件的客户端订阅。
- 订阅 Subscription
- 订阅包含一个主题过滤器（Topic Filter）和一个最大的服务质量（QoS）等级。订阅与单个会话（Session）关联，会话可以包含多于一个的订阅，会话的每个订阅都有一个不同的主题过滤器。

#### 主题名 Topic Name

附加在应用消息上的一个标签，服务端已知且与订阅匹配，服务端发送应用消息的一个副本给每一个匹配的客户端订阅。

#### 主题过滤器 Topic Filter

订阅中包含的一个表达式，用于表示相关的一个或多个主题，主题过滤器可以使用通配符。

#### 会话 Session

客户端和服务端之间的状态交互，一些会话持续时长与网络连接一样，另一些可以在客户端和服务端的多个连续网络连接间扩展。

#### 控制报文 MQTT Control Packet

通过网络连接发送的信息数据包。MQTT规范定义了十四种不同类型的控制报文，其中一个（PUBLISH报文）用于传输应用消息。

## 进一步了解 MQTT3

MQTT3（当前版本 3.1.1）是目前使用的最为广泛的 MQTT 协议标准。尽管 MQTT5 标准已经发布，并且带来了一些令人振奋的新特性，但是在整个应用场景上，从后台服务到消息中间件再到客户端 SDK 等环节上的产品升级并没有都完成，再加上既有部署的维护，业界从版本3到5的过渡可能会持续相当长一段时间，所以，对于刚加入物联网行业的生力军来说，现在来学习 MQTT 3 依然是一件很有意义的事情。

## MQTT 协议的工作方式

前面简介中讲到，在一个QMTT协议中有三个角色会参与到整个通信过程，发布者（publisher）、代理（broker）和订阅者（subscriber）。有别于传统的客户端/服务器通讯协议，MQTT协议并不是端到端的，消息传递通过代理，包括会话（session）也不是建立在发布者和订阅者之间，而是建立在端和代理之间。代理解除了发布者和订阅者之间的耦合。
除了发布者和订阅者之间传递普通消息，代理还可以为发布者处理保留消息和遗愿消息，并可以更改服务质量（QoS）等级。
 
## MQTT 控制报文格式

MQTT 协议通过交换预定义的MQTT控制报文来通信。这一节描述这些报文的格式。

MQTT 控制报文由三部分组成，如下：

![MQTT 固定报头格式](/uploads/images/posts/mqtt/mqtt-protocol-format.png)

#### 固定报头

每个 MQTT 控制报文都 **必须** 包含一个固定报头，用于描述该报文具体行为。

![MQTT 固定报头格式](/uploads/images/posts/mqtt/mqtt-protocol-fixed-header.png)

##### 报文类型（协议名）

**报文类型（协议名）** 用首字节的四位比特（[7-4]）来分别表示 16 中报文类型（0 - 15），不同的值二进制表示方法如下：

| 协议名 | 值 | 报文流动方向 | 描述 |
|:-----:|:--:|:----------:|:---:|
| Reserved    | 0      | 禁止             | 保留
| CONNECT     | 1      | 客户端到服务端   | 客户端请求连接服务端
| CONNACK     | 2      | 服务端到客户端   | 连接报文确认
| PUBLISH     | 3      | 两个方向都允许   | 发布消息
| PUBACK      | 4      | 两个方向都允许   | QoS 1消息发布收到确认
| PUBREC      | 5      | 两个方向都允许   | 发布收到（保证交付第一步）          |
| PUBREL      | 6      | 两个方向都允许   | 发布释放（保证交付第二步）          |
| PUBCOMP     | 7      | 两个方向都允许   | QoS 2消息发布完成（保证交互第三步） |
| SUBSCRIBE   | 8      | 客户端到服务端   | 客户端订阅请求
| SUBACK      | 9      | 服务端到客户端   | 订阅请求报文确认
| UNSUBSCRIBE | 10     | 客户端到服务端   | 客户端取消订阅请求
| UNSUBACK    | 11     | 服务端到客户端   | 取消订阅报文确认
| PINGREQ     | 12     | 客户端到服务端   | 心跳请求
| PINGRESP    | 13     | 服务端到客户端   | 心跳响应
| DISCONNECT  | 14     | 客户端到服务端   | 客户端断开连接
| Reserved    | 15     | 禁止             | 保留 |

##### 标志位

固定报头第1个字节的剩余的 4 位（[3-0]）包含每个 MQTT 控制报文类型特定的标志，见以下表格。表格中任何标记为“保留”的标志位，都是保留给以后使用的，**必须** 设置为表格中列出的值 [MQTT-2.2.2-1]。如果收到非法的标志，接收者 **必须** 关闭网络连接。

| 控制报文 | 固定报头标志 | Bit 3 | Bit 2 | Bit 1 | Bit 0 |
|:-------:|:----------:|:-----:|:-----:|:-----:|:-----:|
| CONNECT | Reserved | 0 | 0 | 0 | 0 |
| CONNACK | Reserved | 0 | 0 | 0 | 0 |
| PUBLISH | Used in MQTT 3.1.1 | DUP<sup>1</sup> | QoS<sup>2</sup> | QoS<sup>2</sup> | RETAIN<sup>3</sup> |
| PUBACK | Reserved | 0 | 0 | 0 | 0 |
| PUBREC | Reserved | 0 | 0 | 0 | 0 |
| PUBREL | Reserved | 0 | 0 | 1 | 0 |
| PUBCOMP | Reserved | 0 | 0 | 0 | 0 |
| SUBSCRIBE | Reserved | 0 | 0 | 1 | 0 |
| SUBACK | Reserved | 0 | 0 | 0 | 0 |
| UNSUBSCRIBE | Reserved | 0 | 0 | 1 | 0 |
| UNSUBACK | Reserved | 0 | 0 | 0 | 0 |
| PINGREQ | Reserved | 0 | 0 | 0 | 0 |
| PINGRESP | Reserved | 0 | 0 | 0 | 0 |
| DISCONNECT | Reserved | 0 | 0 | 0 | 0 |

- DUP<sup>1</sup> =控制报文的重复分发标志
- QoS<sup>2</sup> = PUBLISH报文的服务质量等级
- RETAIN<sup>3</sup> = PUBLISH报文的保留标志

PUBLISH控制报文中的DUP, QoS和RETAIN标志的描述见 3.3.1节。

##### 剩余长度

**剩余长度** 表示当前报文后面还有多少字节，从第二个字节开始，使用 [变长编码]() 方案来表示剩余长度，**最多使用 4 个字节，最少使用 1 个字节。**

**什么是 **变长编码** 方案？**

变长编码，准确的说字节数与数值的大小有关，60 使用一个字节表示，180 却要使用 2 个字节表示。具体表示方法如下：

> 对小于 128 的值它使用单字节编码，更大的数值如下处理：每个字节只是用 **低 7 位**（[6 - 0]）来表示有效位，最高有效位（第 7 位）表示一个 **真/假** 标志，标志后面的字节是否也是表示长度。

例如：`64` 使用一个字节就可以表示（`01000000`）；但是 `321 = 65 + 2 x 128` 需要两个字节来表示（`11000001 00000010`），第一个表示 `65 + 128 = 193`，第二个字节为 `2`。

| 字节数 | 最小值 | 最大值 |
|:-----:|:-----:|:-----:|
| 1 | 0 (0x00)                         | 127 (0x7F)                           |
| 2 | 128 (0x80, 0x01)                 | 16 383 (0xFF, 0x7F)                  |
| 3 | 16384 (0x80, 0x80, 0x01)         | 2 097 151 (0xFF, 0xFF, 0x7F)         |
| 4 | 2097152 (0x80, 0x80, 0x80, 0x01) | 268 435 455 (0xFF, 0xFF, 0xFF, 0x7F) |

#### 可变报头

某些 MQTT 控制报文包含一个可变报头部分。它在固定报头和负载之间。可变报头的内容根据报文类型的不同而不同。可变报头的报文标识符（Packet Identifier）字段存在于在多个类型的报文里。

| Bit | 7  - 0 |
|:---------:|:----------------:|
| byte 1  | 报文标识符 MSB |
| byte 2  | 报文标识符 LSB |

很多控制报文的可变报头部分包含一个两字节的报文标识符字段。这些报文是 PUBLISH（QoS > 0时）， PUBACK，PUBREC，PUBREL，PUBCOMP，SUBSCRIBE, SUBACK，UNSUBSCIBE，UNSUBACK。

SUBSCRIBE，UNSUBSCRIBE和PUBLISH（QoS大于0）控制报文 **必须** 包含一个非零的16位报文标识符（Packet Identifier）[MQTT-2.3.1-1]。客户端每次发送一个新的这些类型的报文时都**必须**分配一个当前未使用的报文标识符 [MQTT-2.3.1-2]。如果一个客户端要重发这个特殊的控制报文，在随后重发那个报文时，它**必须**使用相同的标识符。当客户端处理完这个报文对应的确认后，这个报文标识符就释放可重用。QoS 1 的 PUBLISH 对应的是 PUBACK，QoS 2 的 PUBLISH 对应的是 PUBCOMP，与SUBSCRIBE或UNSUBSCRIBE对应的分别是 SUBACK 或 UNSUBACK [MQTT-2.3.1-3]。发送一个 QoS 0 的 PUBLISH 报文时，相同的条件也适用于服务端 [MQTT-2.3.1-4]。

QoS等于 0 的 PUBLISH 报文 **不能** 包含报文标识符 [MQTT-2.3.1-5]。

PUBACK, PUBREC, PUBREL 报文 **必须** 包含与最初发送的PUBLISH报文相同的报文标识符 [MQTT-2.3.1-6]。类似地，SUBACK 和 UNSUBACK **必须** 包含在对应的 SUBSCRIBE 和 UNSUBSCRIBE 报文中使用的报文标识符 [MQTT-2.3.1-7]。

#### 有效载荷

具体协议内容，不同协议有不同的载荷。

## MQTT 控制报文详解

该部分内容，请查看我的另一篇博客 [MQTT - 控制报文详情/2019/06/27/2019/mqtt-控制报文详情](/2019/06/27/2019/mqtt-控制报文详情)
