---
title: MQTT - 控制报文详情
date: 2019-06-28 09:32:25
categories: [MQTT]
tags:
    - MQTT
---

通过我的上一篇博客 [MQTT - 协议基本详解](/2019/06/27/2019/mqtt-协议基本详解) 可以基本了解到 MQTT 的概念，协议的组成部分（主要由 `固定报头`、`可变报头` 和 有效载荷组成），也知道了 MQTT 协议主要支持的 16 种协议，针对不同的协议，客户端/服务端都需要做出不同的行为，本片博客我们会详细描述一下具体某个协议的组成以及客户端/服务端的处理方式，当然，限于篇幅，我们只列举以下几个协议：`CONNECT`、`CONNACK`、`PUBLICH`、`PUBACK`，这里几个协议分别描述了 MQTT 的建立连接过程、发送消息过程，如果了解更多协议的内容，请参考 [MQTT 3.1.1 - 官方手册](http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.html)。

<!-- more -->

![MQTT - 通信过程](/uploads/images/posts/mqtt/mqtt_process.png)

## 建立连接

MQTT 本身是基于 TCP/IP 协议基础之上协议，依赖于 TCP 连接通道，所有在 TCP 建立握手，建立连接之后，MQTT 协议本身还需要通过 CONNECT 协议报文来确定双方的通信通道，也可以说，建立连接之后的第一个报文必须是 CONNECT 报文。

> **注意：MQTT 协议规定，CONNECT 报文只能发送多次，如果服务器在接收到 CONNECT 之后重复收到，服务端 `必须` 认为客户端是不合法的操作，`必须` 主动断开与客户端的连接。**

### CONNECT

CONNECT 协议报文使用到了 [固定报头](/2019/06/27/2019/mqtt-协议基本详解/#固定报头)、[可变报头](/2019/06/27/2019/mqtt-协议基本详解/#可变报头) 和 [有效载荷](/2019/06/27/2019/mqtt-协议基本详解/#有效载荷) 三部分，其中 **可变报头** 部分包含了 *协议名*、*协议版本*、*标志位* 和 *KeepAlive* 等值；有效载荷部分包含了 *客户端标识符*、*遗嘱主题*、*遗嘱消息*、*用户名*、*用户密码*。

#### 固定报头

固定报头首字节固定为：`0x10`，剩余长度字节依情况而定，组成结构查看下表：

![MQTT - 固定报头](/uploads/images/posts/mqtt/mqtt-connect-fixed-header.png)

#### 可变报头

可变报头包含以下几个部分：*协议名*、*协议版本*、*标志位* 和 *KeepAlive*，组成结构查看下表。

##### 协议名

协议名固定为 `MQTT`，所有该部分字节序固定位：`0x00 0x04 0x4d 0x51 0x54 0x54`，具体查看以下可变报头图表。

##### 协议版本

客户端用 8 位的无符号值表示协议的修订版本。对于 3.1.1 版协议，协议级别字段的值是 4(0x04)。如果发现不支持的协议级别，服务端必须给发送一个返回码为 `0x01`（不支持的协议级别）的 CONNACK 报文响应 CONNECT 报文，然后断开客户端的连接。

##### 标志位

| bit | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| dec | User Name Flag | Password Flag | Will Retain Will QoS | Will Flag | Clean Session | Reserved |
| val | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 |

标志位用于描述某个值的存在与否，使用 1 和 0 来标记，比如：`User Name Flag` 如果设置为 1，则表示 [有效载荷 - 用户名]() 部分数据存在。

1. 清理会话 Clean Session

    **位置**：连接标志字节的第1位

    这个二进制位指定了会话状态的处理方式。

    客户端和服务端可以保存会话状态，以支持跨网络连接的可靠消息传输。这个标志位用于控制会话状态的生存时间。

    如果清理会话（CleanSession）标志被设置为0，服务端 **必须** 基于当前会话（使用客户端标识符识别）的状态恢复与客户端的通信。如果没有与这个客户端标识符关联的会话，服务端**必须**创建一个新的会话。在连接断开之后，当连接断开后，客户端和服务端 **必须**保存会话信息。当清理会话标志为0的会话连接断开之后，服务端 **必须** 将之后的QoS 1和QoS 2级别的消息保存为会话状态的一部分，如果这些消息匹配断开连接时客户端的任何订阅 [[MQTT-3](https://tools.oasis-open.org/issues/browse/MQTT-3).1.2-5]。服务端也 **可以** 保存满足相同条件的QoS 0级别的消息。

    如果清理会话（CleanSession）标志被设置为1，客户端和服务端**必须**丢弃之前的任何会话并开始一个新的会话。会话仅持续和网络连接同样长的时间。与这个会话关联的状态数据**不能**被任何之后的会话重用。

    客户端的会话状态包括：

    - 已经发送给服务端，但是还没有完成确认的QoS 1和QoS 2级别的消息
    - 已从服务端接收，但是还没有完成确认的QoS 2级别的消息。

    服务端的会话状态包括：

    - 会话是否存在，即使会话状态的其它部分都是空。
    - 客户端的订阅信息。
    - 已经发送给客户端，但是还没有完成确认的 QoS 1 和 QoS 2 级别的消息。
    - 即将传输给客户端的 QoS 1 和 QoS 2 级别的消息。
    - 已从客户端接收，但是还没有完成确认的 QoS 2 级别的消息。
    - 可选，准备发送给客户端的 QoS 0 级别的消息。 

    保留消息不是服务端会话状态的一部分，会话终止时**不能**删除保留消息。

    当清理会话标志被设置为1时，客户端和服务端的状态删除不需要是原子操作。

    > **非规范评注**
    >
    > 为了确保在发生故障时状态的一致性，客户端应该使用会话状态标志1重复请求连接，直到连接成功。
    >
    > **非规范评注**
    >
    > 一般来说，客户端连接时总是将清理会话标志设置为0或1，并且不交替使用两种值。这个选择取决于具体的应用。清理会话标志设置为1的客户端不会收到旧的应用消息，而且在每次连接成功后都需要重新订阅任何相关的主题。清理会话标志设置为0的客户端会收到所有在它连接断开期间发布的QoS 1和QoS 2级别的消息。因此，要确保不丢失连接断开期间的消息，需要使用QoS 1或 QoS 2级别，同时将清理会话标志设置为0。
    >
    > **非规范评注**
    >
    > 清理会话标志 0 的客户端连接时，它请求服务端在连接断开后保留它的 MQTT 会话状态。如果打算在之后的某个时间点重连到这个服务端，客户端连接应该只使用清理会话标志 0。当客户端决定之后不再使用这个会话时，应该将清理会话标志设置为0最后再连接一次，然后断开连接。

2. 遗嘱标志 Will Flag

    **位置**：连接标志的第2位。

    遗嘱标志（Will Flag）被设置为1，表示如果连接请求被接受了，遗嘱（Will Message）消息 **必须** 被存储在服务端并且与这个网络连接关联。之后网络连接关闭时，服务端 **必须** 发布这个遗嘱消息，除非服务端收到 DISCONNECT 报文时删除了这个遗嘱消息。

    遗嘱消息发布的条件，包括但不限于：

    - 服务端检测到了一个 I/O 错误或者网络故障。
    - 客户端在保持连接（Keep Alive）的时间内未能通讯。
    - 客户端没有先发送 DISCONNECT 报文直接关闭了网络连接。
    - 由于协议错误服务端关闭了网络连接。

    如果遗嘱标志被设置为 1，连接标志中的 Will QoS 和 Will Retain 字段会被服务端用到，同时有效载荷中 **必须** 包含 Will Topi c和 Will Message 字段。

    一旦被发布或者服务端收到了客户端发送的DISCONNECT报文，遗嘱消息就**必须**从存储的会话状态中移除。

    如果遗嘱标志被设置为 0，连接标志中的Will QoS和Will Retain字段 **必须** 设置为 0，并且有效载荷中 **不能** 包含 Will Topic 和 Will Message 字段。

    如果遗嘱标志被设置为0，网络连接断开时，**不能**发送遗嘱消息。

    服务端应该迅速发布遗嘱消息。在关机或故障的情况下，服务端可以推迟遗嘱消息的发布直到之后的重启。如果发生了这种情况，在服务器故障和遗嘱消息被发布之间可能会有一个延迟。

3. 遗嘱 QoS Will QoS

    **位置**：连接标志的第 4 和第 3 位。

    这两位用于指定发布遗嘱消息时使用的服务质量等级。

    - 如果遗嘱标志被设置为 0，遗嘱 QoS 也 **必须** 设置为 0(0x00)。
    - 如果遗嘱标志被设置为 1，遗嘱 QoS 的值可以等于 0(0x00)，1(0x01)，2(0x02)。它的值 **不能** 等于 3。

4. 遗嘱保留 Will Retain

    **位置**：连接标志的第 5 位。

    - 如果遗嘱消息被发布时需要保留，需要指定这一位的值。
    - 如果遗嘱标志被设置为 0，遗嘱保留（Will Retain）标志也 **必须** 设置为 0 。
    - 如果遗嘱标志被设置为 1：
        - 如果遗嘱保留被设置为0，服务端**必须**将遗嘱消息当作非保留消息发布。
        - 如果遗嘱保留被设置为1，服务端**必须**将遗嘱消息当作保留消息发布。

5. 密码标志 Password Flag

    **位置**：连接标志的第 6 位。

    - 如果密码（Password）标志被设置为0，有效载荷中 **不能** 包含密码字段。
    - 如果密码（Password）标志被设置为1，有效载荷中 **必须** 包含密码字段。
    - 如果用户名标志被设置为0，密码标志也**必须**设置为 0。

6. 用户名标志 User Name Flag

    **位置**：连接标志的第 7 位。

    - 如果用户名（User Name）标志被设置为0，有效载荷中**不能**包含用户名字段。
    - 如果用户名（User Name）标志被设置为1，有效载荷中**必须**包含用户名字段。

##### KeepAlive

MQTT 客户端/服务端 **必须** 实现连接保持机制，该机制表示：**它是指在客户端传输完成一个控制报文的时刻到发送下一个报文的时刻**。也就是说 MQTT 协议中两个连续报文的时间间隔不能超过 `KeepAlive` 值，如果超过则客户端/服务端 **必须** 认为对端已断开，然后关闭该连接。

> **注：MQTT 协议实现了 PINGREQ 和 PINGRESP 两个协议来完成连接保持机制。**

##### 可变报头图表描述

![MQTT - 可变报头](/uploads/images/posts/mqtt/mqtt-connect-variable-header.png)

#### 有效载荷

有效载荷部分包含了 *客户端标识符*、*遗嘱主题*、*遗嘱消息*、*用户名*、*用户密码*。具体组成结构都为：`2 个字节长度` + `具体内容`，这样我们就很好解析了，先获取字节长度 len，在读 len 个字节表示该部分数据。

##### 客户端标识符

每个连接都必须有一个唯一的客户端标识符来标识该链接。

他必须满足以下条件：

- 客户端标识符 (ClientId) **必须** 存在而且 **必须** 是 CONNECT 报文有效载荷的第一个字段。
- 客户端标识符 **必须** 是1.5.3节定义的UTF-8编码字符串。 
- 服务端 **必须** 允许 1 到 23 个字节长的UTF-8编码的客户端标识符，客户端标识符只能包含这些字符：`/^[0-91-zA-Z]{1,23}$/`（大写字母，小写字母和数字）。
- 服务端 **可以** 允许编码后超过23个字节的客户端标识符 (ClientId)。
- 服务端 **可以** 允许包含不是上面列表字符的客户端标识符 (ClientId)。
- 服务端 **可以** 允许客户端提供一个零字节的客户端标识符 (ClientId) ，如果这样做了，服务端 **必须** 将这看作特殊情况并分配唯一的客户端标识符给那个客户端。然后它 **必须**假设客户端提供了那个唯一的客户端标识符，正常处理这个CONNECT报文。
- 如果客户端提供的 ClientId 为零字节且清理会话标志为 0，服务端**必须**发送返回码为 0x02（表示标识符不合格）的 CONNACK 报文响应客户端的 CONNECT 报文，然后关闭网络连接。
- 如果服务端拒绝了这个 ClientId，它 **必须** 发送返回码为 0x02（表示标识符不合格）的 CONNACK 报文响应客户端的 CONNECT 报文，然后关闭网络连接。

##### 遗嘱主题

如果 `遗嘱标志` 设置为 1，则该部分就存在。

##### 遗嘱消息

如果 `遗嘱标志` 设置为 1，则该部分就存在。

如果遗嘱标志被设置为1，有效载荷的下一个字段是遗嘱消息。遗嘱消息定义了将被发布到遗嘱主题的应用消息，这个字段由一个两字节的长度和遗嘱消息的有效载荷组成，表示为零字节或多个字节序列。长度给出了跟在后面的数据的字节数，不包含长度字段本身占用的两个字节。

遗嘱消息被发布到遗嘱主题时，它的有效载荷只包含这个字段的数据部分，不包含开头的两个长度字节。

##### 用户名

如果用户名（User Name）标志被设置为 1，有效载荷的下一个字段就是它。用户名 **必须** 是 UTF-8编码字符串。服务端可以将它用于身份验证和授权。

##### 用户密码

如果密码（Password）标志被设置为 1，有效载荷的下一个字段就是它。密码字段包含一个两字节的长度字段，长度表示二进制数据的字节数（不包含长度字段本身占用的两个字节），后面跟着 0 到 65535 字节的二进制数据。

##### 有效载荷图表描述

![MQTT - 有效载荷](/uploads/images/posts/mqtt/mqtt-connect-payload.png)

### CONNACK

CONNACK（Acknowledge Connection Request）是对 CONNECT 报文的响应协议，服务端发送 CONNACK 报文响应从客户端收到的 CONNECT 报文。服务端发送给客户端的第一个报文必须是 CONNACK。

如果客户端在合理的时间内没有收到服务端的 CONNACK 报文，客户端应该关闭网络连接。合理 的时间取决于应用的类型和通信基础设施。

![MQTT - CONNACK](/uploads/images/posts/mqtt/mqtt-connack.png)

#### 连接确认标志

可变报头第一个字节，用来表示连接确认标志（只使用第一个比特位，其余七位比特保留）。

如果服务端收到清理会话（CleanSession）标志为 1 的连接，除了将 CONNACK 报文中的返回码设置为 0 之外，还 **必须** 将 CONNACK 报文中的当前会话设置（Session Present）标志为 0。

如果服务端收到一个 CleanSession 为 0 的连接，当前会话标志的值取决于服务端是否已经保存了 ClientId 对应客户端的会话状态。如果服务端已经保存了会话状态，它 **必须** 将CONNACK报文中的当前会话标志设置为 1。如果服务端没有已保存的会话状态，它 **必须** 将CONNACK报文中的当前会话设置为0。还需要将CONNACK报文中的返回码设置为 0。

当前会话标志使服务端和客户端在是否有已存储的会话状态上保持一致。

一旦完成了会话的初始化设置，已经保存会话状态的客户端将期望服务端维持它存储的会话状态。如果客户端从服务端收到的当前的值与预期的不同，客户端可以选择继续这个会话或者断开连接。客户端可以丢弃客户端和服务端之间的会话状态，方法是，断开连接，将清理会话标志设置为 1，再次连接，然后再次断开连接。

如果服务端发送了一个包含非零返回码的 CONNACK 报文，它 **必须** 将当前会话标志设置为 0 。

#### 响应状态码

可变报头最后一个字节，来标识响应状态码，状态码含义如下表：

| 响应状态码 | 返回码响应 | 描述 |
|:----:|:------:|:------:|
| 0x00 | 连接已接受 | 连接已被服务端接受 |
| 0x01 | 连接已拒绝，不支持的协议版本 | 服务端不支持客户端请求的MQTT协议级别 |
| 0x02 | 连接已拒绝，不合格的客户端标识符 | 客户端标识符是正确的UTF-8编码，但服务端不允许使用 |
| 0x03 | 连接已拒绝，服务端不可用 | 网络连接已建立，但MQTT服务不可用 |
| 0x04 | 连接已拒绝，无效的用户名或密码 | 用户名或密码的数据格式无效 |
| 0x05 | 连接已拒绝，未授权 | 客户端未被授权连接到此服务器 |
| 0x06-0xFF | 保留 | 保留 |

如果认为上表中的所有连接返回码都不太合适，那么服务端 **必须** 关闭网络连接，不需要发送 CONNACK 报文。

> **注：CONNACK 没有有效载荷。**

## 发送消息

客户端之间，客户端与服务端之间需要正常的发送消息，我们使用 `PUBLISH` 来运输数据。

### PUBLISH

PUBLISH 控制报文是指从客户端向服务端或者服务端向客户端传输一个应用消息。

![MQTT - CONNACK](/uploads/images/posts/mqtt/mqtt-publish.png)

#### 固定报头

固定报头的首字节 **标志位** 包含：*重发标志 DUP*、*服务质量等级 QoS Level* 和 *保留标志 RETAIN*。

##### 重发标志 DUP

**位置**：第 1 个字节，第 3 位

如果 DUP 标志被设置为 0，表示这是客户端或服务端第一次请求发送这个 PUBLISH 报文。如果 DUP 标志被设置为1，表示这可能是一个早前报文请求的重发。

客户端或服务端请求重发一个 PUBLISH 报文时，**必须** 将 DUP 标志设置为 1。对于 QoS 0 的消息，DUP 标志 **必须** 设置为 0。

服务端发送 PUBLISH 报文给订阅者时，收到（入站）的 PUBLISH 报文的 DUP 标志的值不会被传播。发送（出站）的 PUBLISH 报文与收到（入站）的 PUBLISH 报文中的 DUP 标志是独立设置的，它的值 **必须** 单独的根据发送（出站）的 PUBLISH 报文是否是一个重发来确定。

> **非规范评注**
>
> 接收者收到一个 DUP 标志为 1 的控制报文时，不能假设它看到了一个这个报文之前的一个副本。
>
> **非规范评注**
>
> 需要特别指出的是，DUP 标志关注的是控制报文本身，与它包含的应用消息无关。当使用 QoS 1 时，客户端可能会收到一个 DUP 标志为 0 的 PUBLISH 报文，这个报文包含一个它之前收到过的应用消息的副本，但是用的是不同的报文标识符。

##### 服务质量等级 QoS Level

**位置**：第 1 个字节，第 2-1 位。

这个字段表示应用消息分发的服务质量等级保证，服务质量定义如下表：

| QoS 值 | Bit 2 | Bit 1 | 描述 |
|:------:|:------:|:------:|:------:|
| 0 | 0 | 0 | 最多分发一次 |
| 1 | 0 | 1 | 至少分发一次 |
| 2 | 1 | 0 | 只分发一次   |
| - | 1 | 1 | 保留位      |

PUBLISH报文 **不能** 将 QoS 所有的位设置为1。如果服务端或客户端收到 QoS 所有位都为1的 PUBLISH 报文，它 **必须** 关闭网络连接。

##### 保留标志 RETAIN

**位置**：第 1 个字节，第 3 位

#### 可变报头

可变报头按顺序包含 **主题名** 和 **报文标识符**。

##### 主题名

主题名（Topic Name）用于识别有效载荷数据应该被发布到哪一个信息通道。

主题名 **必须** 是 PUBLISH 报文可变报头的第一个字段。它 **必须** 是 UTF-8 编码的字符串。

PUBLISH报文中的主题名 **不能** 包含通配符。

服务端发送给订阅客户端的 PUBLISH 报文的主题名 **必须** 匹配该订阅的主题过滤器。

##### 报文标识符

只有当 QoS 等级是 1 或 2 时，报文标识符（Packet Identifier）字段才能出现在 PUBLISH 报文中，用于维护客户端/服务端维护某个消息，如果客户端/服务端接收到该报文并会响应对应的报文（QoS 1 响应 PUBACK，QoS 2 响应 PUBREC），对应报文中会携带该 *报文标识符*。

#### 有效载荷

有效载荷包含将被发布的应用消息。数据的内容和格式是应用特定的。有效载荷的长度这样计算：用固定报头中的剩余长度字段的值减去可变报头的长度。包含零长度有效载荷的 PUBLISH 报文是合法的。

#### 响应

PUBLISH 报文的接收者 **必须** 按照根据 PUBLISH 报文中的 QoS 等级发送响应，见下面表格的描述：

| 服务质量等级 | 预期响应 |
|:----------:|:-------:|
| QoS 0 | 无响应       |
| QoS 1 | PUBACK报文   |
| QoS 2 | PUBREC报文   |

#### 动作 Actions

客户端使用 PUBLISH 报文发送应用消息给服务端，目的是分发到其它订阅匹配的客户端。

服务端使用 PUBLISH 报文发送应用消息给每一个订阅匹配的客户端。

客户端使用带通配符的主题过滤器请求订阅时，客户端的订阅可能会重复，因此发布的消息可能会匹配多个过滤器。对于这种情况，服务端 **必须** 将消息分发给所有订阅匹配的 QoS 等级最高的客户端。服务端之后可以按照订阅的 QoS 等级，分发消息的副本给每一个匹配的订阅者。

收到一个 PUBLISH 报文时，接收者的动作取决于 QoS 等级。

如果服务端实现不授权某个客户端发布 PUBLISH 报文，它没有办法通知那个客户端。它 **必须** 按照正常的 QoS 规则发送一个正面的确认，或者关闭网络连接。

### PUBACK

`PUBACK` 是对 `QoS 1` 的 `PUBLISH` 报文的响应协议报文。

![MQTT - CONNACK](/uploads/images/posts/mqtt/mqtt-puback.png)

该协议报文 **可变报头** 只包含 2 个字节（标识需要回复的 PUBLISH 报文的 **标识符 Client Identifier**），客户端/服务端收到该报文时，需要将对应的 PUBLISH 报文标记为已送达。

> **注：CONNACK 没有有效载荷。**

## 其余协议

剩余协议的解释，组成结构请参考 [MQTT 3.1.1 - 官方手册](http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.html)。

## 参考链接

[MQTT Version 3.1.1 Official Manual](http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.html)
